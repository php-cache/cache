dist: trusty
sudo: required
language: php

env:
    global:
        - COVERAGE=false
        - PHPUNIT="./vendor/bin/phpunit --verbose"
        - PHPUNIT_X="./vendor/bin/phpunit --exclude-group benchmark"
        - PHPUNIT_COVERAGE="./vendor/bin/phpunit --coverage-clover=coverage.xml"
        - COMPOSER_UP="composer update --no-interaction --prefer-dist --no-progress --profile --no-suggest"

branches:
    except:
        - /^analysis-.*$/
        - /^patch-.*$/

services:
    - redis
    - memcached
    - mongodb

addons:
    apt:
        sources:
            - mongodb-3.2-precise
        packages:
            - parallel
            - mongodb-org-server

cache:
    directories:
        - $HOME/.composer/cache/files

before_install:
    - if [[ $COVERAGE == false ]]; then phpenv config-rm xdebug.ini || true; fi
    - mkdir -p ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d
    - ./build/php/all.sh
    - ./build/RedisClusterSetup.sh
    - sleep 5 # To make sure all services installed and running
    - stty cols 120
    - wget https://cdn.rawgit.com/prisis/43a2a7b137998ac92e24ee4daaa8e296/raw/681b89b8e156750de46558ead661509c468fb9a2/try_catch.sh -P ./build
    - wget https://cdn.rawgit.com/prisis/e050c4da44c6ee7fa1519912eac19563/raw/7a72a7df7718af30e703c1ef0379cdf7ff24ce10/tfold.sh -P ./build
    - chmod a+x ./build/components_phpunit.sh
    - |
      # php.ini configuration
      INI=~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
      echo memory_limit = -1 >> $INI

script:
    - ./build/components_phpunit.sh

jobs:
    include:
        - stage: Test
          php: 5.6
        - stage: Test
          php: 5.6
          env: DEPS="low"
        - stage: Test
          php: 7.0
        - stage: Test
          php: 7.1
        - stage: Test
          php: 7.2
        - stage: Test
          php: 7.2
          env: DEPS="high"

        - stage: Coverage
          php: 7.2
          env: COVERAGE=true
          script:
            - $PHPUNIT_COVERAGE
          after_success:
            - bash <(curl -s https://codecov.io/bash)

notifications:
    email: false
    webhooks:
        urls:
            - https://webhooks.gitter.im/e/7b0035a70de31fa976df
