dist: trusty
sudo: required
language: php

env:
    global:
        - COVERAGE=false
        - PHPUNIT="./vendor/bin/phpunit --verbose"
        - PHPUNIT_X="./vendor/bin/phpunit --verbose --exclude-group benchmark"
        - PHPUNIT_COVERAGE="./vendor/bin/phpunit --verbose --coverage-clover=coverage.xml"
        - COMPOSER_UP="composer update --no-interaction --prefer-dist --no-progress --profile --no-suggest"

branches:
    except:
        - /^analysis-.*$/
        - /^patch-.*$/

services:
    - redis-server
    - memcached
    - mongodb

addons:
    apt:
        sources:
            - mongodb-3.2-precise
        packages:
            - parallel
            - mongodb-org-server

cache:
    directories:
        - ${HOME}/.composer/cache/files
        - ${HOME}/php-ext

before_install:
    - pecl channel-update pecl.php.net
    - if [[ $COVERAGE == false ]]; then phpenv config-rm xdebug.ini || true; fi
    - mkdir -p ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d
    - chmod a+x ./build/components_phpunit.sh && chmod a+x ./build/build_php_extensions.sh
    - wget https://cdn.rawgit.com/prisis/e050c4da44c6ee7fa1519912eac19563/raw/7a72a7df7718af30e703c1ef0379cdf7ff24ce10/tfold.sh -P ./build
    - wget https://cdn.rawgit.com/prisis/4e81f5e52ad7e11518e4d2eb81d7e89d/raw/765b9ee3a2f2c48edac7f4ecae9f6e02662902a4/tpecl.sh -P ./build
    - ./build/build_php_extensions.sh
    - ./build/RedisClusterSetup.sh
    - sleep 5 # To make sure all services installed and running
    - stty cols 120
    - echo memory_limit=-1 >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini # set memory limit to unlimited

script:
    - ./build/components_phpunit.sh

jobs:
    include:
        - stage: Test
          php: 5.6
          env: DEPS="low" APCU_VERSION=4.0.11 MEMCACHE_VERSION=2.2.7 MEMCACHED_VERSION="stable" MONGODB_VERSION=1.4.2 REDIS_VERSION=2.2.8
        - stage: Test
          php: 7.0
          env: APCU_VERSION=5.1.8 MEMCACHED_VERSION="stable" MONGODB_VERSION=1.4.2 REDIS_VERSION=3.0.0
        - stage: Test
          php: 7.1
          env: APCU_VERSION=5.1.8 MEMCACHED_VERSION="stable" MONGODB_VERSION=1.4.2 REDIS_VERSION=3.0.0
        - stage: Test
          php: 7.2
          env: DEPS="high" APCU_VERSION=5.1.8 MEMCACHED_VERSION="stable" MONGODB_VERSION=1.4.2 REDIS_VERSION=3.1.6

        - stage: Coverage
          php: 7.2
          env: COVERAGE=true APCU_VERSION=5.1.8 MEMCACHED_VERSION="stable" MONGODB_VERSION=1.4.2 REDIS_VERSION=3.1.6
          script:
            - $PHPUNIT_COVERAGE
          after_success:
            - bash <(curl -s https://codecov.io/bash)

notifications:
    email: false
    webhooks:
        urls:
            - https://webhooks.gitter.im/e/7b0035a70de31fa976df
